# 多线程并发与线程安全

## 共享变量

如果一个变量在多个线程的工作内存中都存在副本，那么这个变量就是这几个线程的共享变量。


## java内存模型（Java Memory Model，简称JMM）

JMM描述了java程序中各种变量（线程共享变量）的访问规则，以及在JVM中将变量存储到内存和从内存中读取出变量这样的底层细节。

### 规则1： 

* 所有的变量都存储在主内存中 

* 每个线程都有自己独立的工作内存，里面保存该线程使用到的变量的副本（主内存中该变量的一份拷贝） 

### 规则2： 

* 线程对共享变量的所有操作都必须在自己的工作内存中进行，不能直接从主内存中读写 

* 不同线程之间无法直接访问其他线程工作内存中的变量，线程间变量的传递需要通过主内存来完成

### 模型图

* 线程1 <--> 工作内存1,x的副本1 <--> 主内存，共享变量x
* 线程2 <--> 工作内存2,x的副本2 <--> 主内存，共享变量x
* 线程3 <--> 工作内存3,x的副本3 <--> 主内存，共享变量x


## 指令重排 

代码书写的顺序与实际执行的顺序不同，指令重排序是编译器或处理器为了提高程序性能而做的优化（有些代码翻译成机器指令之后，如果进行一个重排序，那可能重排序之后的顺序更加符合CPU执行的特点，这样就可以最大限度发挥CPU的性能） 

* 编译器优化的重排序（编译器） 

* 指令级并行重排序（处理器优化） 

* 内存系统的重排序(处理器优化)


## as-if-serial语义 

无论如何重排序，程序执行的结果应该与代码顺序执行的结果一致（java编译器、运行时和处理器都会保证java在单线程下遵循as-if-serial语义） 
int num1=1; 
int num2=2; 
int sum=num1+num2; 
单线程：第1、2行的顺序可以重排，但第3行不能